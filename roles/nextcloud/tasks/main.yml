---
- name: Create nextcloud data directory if it does not exist
  ansible.builtin.file:
    path: "{{ data_vol }}"
    state: directory
    mode: '0755'

- name: Deploy nextcloud instance
  community.docker.docker_swarm_service:
    name: nextcloud
    image: nextcloud:23.0-apache
    restart_config:
      condition: on-failure
    placement:
      constraints:
        - node.role == manager
    networks:
      - name: host
    mode: replicated
    replicas: 1
    mounts:
      - source: "{{ data_vol }}"
        target: /var/www/html
        type: bind
    env:
      POSTGRES_DB: nextcloud
      POSTGRES_USER: nextcloud
      POSTGRES_PASSWORD: nextcloud
      POSTGRES_HOST: 127.0.0.1
      NEXTCLOUD_ADMIN_USER: admin
      NEXTCLOUD_ADMIN_PASSWORD: admin